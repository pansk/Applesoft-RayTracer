10 GOTO 20000
100 REM INTERSECTION WITH SPHERE
101 REM INPUT: OX, OY, OZ - ORIGIN
102 REM INPUT: DX, DY, DZ - DIRECTION
103 REM INPUT: CX, CY, CZ - SPHERE CENTER
104 REM INPUT: R - SPHERE RADIUS
105 REM INPUT: T - PREVIOUS HIT
110 PX=OX-CX:PY=OY-CX:PZ=OZ-CZ
120 A=DX*DX+DY*DY+DZ*DZ
130 B=DX*PX+DY*PY+DZ*PZ
140 C=PX*PX+PY*PY+PZ*PZ-R*R
150 D=B*B-A*C
160 IF D < 0 THEN RETURN
170 D = SQR(D)
180 T1 = (- B - D)/A
190 IF T1 > T THEN RETURN
200 IF T1 < 0 THEN T1 = (- B + D) / A: IF T1 < 0 OR T1 > T THEN RETURN
210 T = T1:M = OM:NX=(PX+T*DX)/R:NY=(PY+T*DY)/R:NZ=(PZ+T*DZ)/R:RETURN
300 REM PLANE INTERSECTION
301 REM INPUT: OX, OY, OZ - ORIGIN
302 REM INPUT: DX, DY, DZ - DIRECTION
303 REM INPUT: A, B, C, D - PLANE PARAMETERS
304 REM INPUT: T - PREVIOUS HIT
310 DE = A*DX+B*DY+C*DZ
320 IF DE=0 THEN RETURN
330 T1 = -(D + A*OX + B*OY + C*OZ)/DE
340 IF T1 > 0 AND T1 < T THEN T = T1:M = OM
350 RETURN
500 T = 1000:M = 0:PI = I:I = 0
510 IF PI <> 1 THEN GOSUB 10110
520 IF PI <> 2 THEN GOSUB 10210
530 IF PI <> 3 THEN GOSUB 10310
540 IF M = 0 THEN RETURN
550 OX = OX+T*DX:OY = OY+T*DY:OZ = OZ+T*DZ
560 IF M = 1 THEN GOTO 600
570 GOTO 20200
600 REM CHECKERBOARD
610 K = INT(OX / 4) + INT(OZ / 4)
620 IF (K%-2*INT(K%/2))=0 THEN RETURN
630 HPLOT X, Y:RETURN
700 REM REFLECTION
710 K = 2*(DX*NX+DY*NY+DZ*NZ)
720 DX = DX-K*NX:DY = DY-K*NY:DZ = DZ-K*NZ
730 GOTO 500
10000 REM SCENE FUNCTIONS
10100 REM SPHERE IN SCENE
10110 CX = -5:CY = 4:CZ = 10:R = 4:OM = 2:GOTO 100
10200 REM PLANE IN SCENE
10210 A = 0:B = 1: C = 0:D = 0:OM = 1:GOTO 300
10300 REM SECOND SPHERE
10310 CX = 5:CY = 7:CZ = 13:R = 2:OM = 2: GOTO 100
20000 HGR:HCOLOR = 3
20010 MX = 0:MY = 1.7:MZ = 0
20020 SX = 0:SY = 0:SZ = 1
20030 UX = 0:UY = 1:UZ = 0
20040 RX = 1:RY = 0:RZ = 0
20050 SC = 0.01
20100 FOR X = 0 TO 279: FOR Y = 0 TO 159
20110 OX = MX:OY = MY:OZ = MZ
20120 DX = (X-139.5)*SC:DY = (79.5-Y)*SC:DZ = 1
20130 I = 0:GOSUB 30000
20140 NEXT Y:NEXT X
20150 END



